<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Beyond the basics with Cloud Foundry :: congx.dev</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="The advent of Docker changed the way we develop applications. Once you had written a Dockerfile and built the image, your application will run (almost) anywhere, regardless of the underlying operating system, and best of all, it just works. You can then expose ports, map volumes to persist data and deploy your image in Docker Swarm or Kubernetes (K8s). With great flexibility, however, comes greater costs, whether that is increased developer&amp;rsquo;s skillset requirements and time spent on writing multiple K8s YAML config files, or pricier services on your favourite cloud provider." />
<meta name="keywords" content=", " />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://congx.dev/posts/beyond-the-basics-with-cloud-foundry/" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-35148726-3', 'auto');
	
	ga('send', 'pageview');
}
</script>



<link rel="stylesheet" href="https://congx.dev/assets/style.css">

  <link rel="stylesheet" href="https://congx.dev/assets/light_blue.css">






<link rel="apple-touch-icon" href="https://congx.dev/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://congx.dev/img/favicon/light_blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Beyond the basics with Cloud Foundry">
<meta property="og:description" content="The advent of Docker changed the way we develop applications. Once you had written a Dockerfile and built the image, your application will run (almost) anywhere, regardless of the underlying operating system, and best of all, it just works. You can then expose ports, map volumes to persist data and deploy your image in Docker Swarm or Kubernetes (K8s). With great flexibility, however, comes greater costs, whether that is increased developer&amp;rsquo;s skillset requirements and time spent on writing multiple K8s YAML config files, or pricier services on your favourite cloud provider." />
<meta property="og:url" content="https://congx.dev/posts/beyond-the-basics-with-cloud-foundry/" />
<meta property="og:site_name" content="congx.dev" />

  <meta property="og:image" content="https://congx.dev/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2019-06-12 23:00:00 &#43;1100 &#43;1100" />












</head>
<body class="light_blue">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Cong&#39;s little blog
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/readme">README</a></li>
        
      
        
          <li><a href="/toc">T.O.C</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/readme">README</a></li>
      
    
      
        <li><a href="/toc">T.O.C</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://congx.dev/posts/beyond-the-basics-with-cloud-foundry/">Beyond the basics with Cloud Foundry</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2019-06-12 
      </span>
    
    
    <span class="post-author">:: Cong Nguyen</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://congx.dev/tags/ibm/">IBM</a>&nbsp;
    
    #<a href="https://congx.dev/tags/cloud-foundry/">Cloud Foundry</a>&nbsp;
    
    #<a href="https://congx.dev/tags/toddler/">toddler</a>&nbsp;
    
  </span>
  

  

  
    <div class="table-of-contents">
      <h2>
        
          Table of Contents
        
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#which-cf-cli-to-use">Which CF CLI to use</a></li>
    <li><a href="#developing-locally-with-cf-local">Developing locally with CF Local</a></li>
    <li><a href="#deploying-docker-images-into-cf-containers">Deploying Docker images into CF containers</a></li>
    <li><a href="#sequencing-applications-start-up">Sequencing applications start-up</a></li>
    <li><a href="#configuring-container-to-container-networking">Configuring container-to-container networking</a>
      <ul>
        <li><a href="#what-i-need-is-tcp-routing">What I need is TCP routing</a></li>
        <li><a href="#actually-configuring-c2c-networking">Actually configuring C2C networking</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <p>The advent of Docker changed the way we develop applications. Once you had written a Dockerfile and built the image, your application will run (almost) anywhere, regardless of the underlying operating system, and best of all, it just works. You can then expose ports, map volumes to persist data and deploy your image in Docker Swarm or Kubernetes (K8s). With great flexibility, however, comes greater costs, whether that is increased developer&rsquo;s skillset requirements and time spent on writing multiple K8s YAML config files, or pricier services on your favourite cloud provider.</p>
<p>This blog post presents the usage of different tools and interesting tidbits to ease development with Cloud Foundry (CF), similar to the likes of Docker. These include:</p>
<ul>
<li>Developing and testing CF applications locally</li>
<li>Running Docker images inside a CF container</li>
<li>Sequencing start-ups of multiple CF applications</li>
<li>Configuring container-to-container networking</li>
</ul>
<p>For the remainder of this blog post, I will be using <a href="https://github.com/rampadc/toddler-auth">toddler-auth</a> as the example.</p>
<h2 id="which-cf-cli-to-use">Which CF CLI to use<a href="#which-cf-cli-to-use" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Just before we get started, if you are using the standalone IBM Cloud CLI, it bundles in CF CLI. Everything that comes after <code>ibmcloud cf</code> maps to the normal Cloud Foundry cf&rsquo;s command. Personally, because I use IBM Cloud day-to-day, I removed <code>cf</code> and created an alias to <code>ibmcloud cf</code> with <code>alias cf='ibmcloud cf'</code>. Henceforth, any mentions of <code>cf</code> refers to <code>ibmcloud cf</code>.</p>
<h2 id="developing-locally-with-cf-local">Developing locally with CF Local<a href="#developing-locally-with-cf-local" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><a href="https://pivotal.io/cf-local">CF Local</a> lets you develop locally and requires Docker to be installed. To install CF Local, invoke <code>cf install-plugin cflocal</code>. CF Local <a href="https://github.com/cloudfoundry-incubator/cflocal/issues/3">only</a> uses a <code>local.yml</code> instead of <code>manifest.yml</code>.</p>
<p>Writing <code>local.yml</code> is similar to a <code>docker-compose.yml</code> file. After all, they are YAML files. You can place multiple applications, specify environment variables just like any CF apps.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">applications</span>:
- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">toddler-auth</span>
  <span style="color:#f92672">routes</span>:
    - <span style="color:#f92672">route</span>: <span style="color:#ae81ff">toddler-auth.apps.internal</span>
  <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128M</span>
  <span style="color:#f92672">disk_quota</span>: <span style="color:#ae81ff">128M</span>
  <span style="color:#f92672">env</span>:
    <span style="color:#f92672">TODDLER_USERNAME</span>: <span style="color:#ae81ff">&lt;username&gt;</span>
    <span style="color:#f92672">TODDLER_PASSWORD</span>: <span style="color:#ae81ff">&lt;password&gt;</span>
    <span style="color:#f92672">TODDLER_WORLD_ID</span>: <span style="color:#ae81ff">&lt;worldId&gt;</span>
</code></pre></div><p>Once you have navigated to the application folder, stage the application with <code>cf local stage toddler-auth</code>.</p>
<p>Staging the application&hellip;</p>
<p><img src="./stage.gif" alt="staging"></p>
<p>Then, run the application with cf local run toddler-auth.</p>
<p>Running&hellip;</p>
<p><img src="./run.gif" alt="running"></p>
<p>The first staging period can take some time to download buildpacks and set things up, but once it completes, CF Local creates <code>.cache</code> files inside the application&rsquo;s directory. Subsequent runs are faster.</p>
<h2 id="deploying-docker-images-into-cf-containers">Deploying Docker images into CF containers<a href="#deploying-docker-images-into-cf-containers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><a href="https://www.cloudfoundry.org/blog/garden-and-runc/">Sometime in 2015</a>, Cloud Foundry started to support Docker images by adopting the Open Container Initiative (OCI) container execution interface. For more information on deploying a Docker image, have a look at the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/push-docker.html">full documentation</a>. Two most important tidbits are:</p>
<ul>
<li>Only 1 exposed port per image is supported.</li>
<li>Exposed port is controlled by the <code>EXPOSE</code> directive in the Dockerfile.</li>
</ul>
<p>While you can control the exposed port by other means as outlined in the docs, using the default exposed port is the easiest way to go. An example to using a Docker image is provided in toddler-auth&rsquo;s <code>manifest.yml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
<span style="color:#f92672">applications</span>:
- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">toddler-nats</span>
  <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">128M</span>
  <span style="color:#f92672">disk_quota</span>: <span style="color:#ae81ff">256M</span>
  <span style="color:#f92672">docker</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">bitnami/nats:latest</span>
  <span style="color:#f92672">routes</span>:
    - <span style="color:#f92672">route</span>: <span style="color:#ae81ff">toddler-nats.apps.internal</span>
</code></pre></div><p>In the above example, I am running an application named toddler-nats. It uses bitnami&rsquo;s nats.io image from Docker Hub and maps an internal route of <code>toddler-nats.apps.internal</code>.</p>
<h2 id="sequencing-applications-start-up">Sequencing applications start-up<a href="#sequencing-applications-start-up" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In the world of Docker Compose, Swarm and Kubernetes, applications are started in parallel. Applications startup sequence is not controlled by the orchestrator. This can be annoying as you need to write extra bash files and build in service availability detection.</p>
<p>On the contrary, if your manifest.yml contains multiple applications, CF applications are deployed in sequence during deployment from top to bottom. If any application in the chain fails, the entire deployment is halted. This is great if you need to sequence start-ups of multiple applications.</p>
<h2 id="configuring-container-to-container-networking">Configuring container-to-container networking<a href="#configuring-container-to-container-networking" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Before touching on container-to-container networking, I just want to touch on why this was significant for my project.</p>
<h3 id="what-i-need-is-tcp-routing">What I need is TCP routing<a href="#what-i-need-is-tcp-routing" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>My Toddler stack relies on NATS as the centralised message queue for microservices' communication. NATS is a great alternative to HTTP. It&rsquo;s got all the nice features of a message queue like pub/sub, topic routing, very high throughput and well-developed client libraries.</p>
<p>In mid-2016, Cloud Foundry <a href="https://www.cloudfoundry.org/blog/tcp-routing-comes-to-cloud-foundry/">rolled out support for TCP routing</a>. Not all cloud providers, however, support this feature. IBM Cloud for one, does not.</p>
<p><img src="./no-tcp-routing.png" alt="no-tcp"></p>
<p>From the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/routes-domains.html#list-routes">listing routes</a> doc, if <code>tcp</code> is shown under type for any route, that route can be configured as a TCP route. Well, my public CF account does not. Searching around revealed that you can, however, set up custom TCP port with <a href="https://www.ibm.com/cloud/blog/cloud-foundry-container-to-container-networking">container-to-container networking (C2C networking)</a>.</p>
<h3 id="actually-configuring-c2c-networking">Actually configuring C2C networking<a href="#actually-configuring-c2c-networking" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Setting up C2C networking was straightforward. C2C networking is disabled by default. To enable C2C between 2 applications, you first need both apps deployed. Then, invoke</p>
<p><code>ibmcloud cf add-network-policy $SOURCE_APP_NAME --destination-app $DEST_APP_NAME --port $PORT --protocol tcp</code></p>
<p>For my project, I needed to enabled port 4222 from toddler-auth to toddler-nats. On my terminal, this was</p>
<p><code>cf add-network-policy toddler-auth --destination-app toddler-nats --port 4222 --protocol tcp</code></p>
<p>To talk to toddler-nats, I mapped an internal route on toddler-nats to be <code>toddler-nats.apps.internal</code>. To talk to toddler-nats, <code>nats://toddler-nats.app.internal</code> was used.</p>
<p>Something to note here was that I did not have to add a network policy into CF Local when deploying the application locally.</p>
<h2 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>To summarise,</p>
<ul>
<li>Developing and testing locally with CF Local maps to locally build an image and test a deployment with docker-compose.</li>
<li>Configuring container-to-container networking maps to calling services within a docker-compose file.</li>
<li>Running a Docker image inside a CF container was a good-to-know.</li>
<li>Sequencing application start-up was a good-to-know.</li>
</ul>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://congx.dev/posts/birth-of-toddler/">
                <span class="button__icon">←</span>
                <span class="button__text">Birth of Toddler</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://congx.dev/posts/thinkpad-keyboards-controllers/">
                <span class="button__text">There will be ThinkPad keyboard controllers</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://congx.dev/assets/main.js"></script>
<script src="https://congx.dev/assets/prism.js"></script>







  
</div>

</body>
</html>
