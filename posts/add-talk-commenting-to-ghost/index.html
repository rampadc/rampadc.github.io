<!DOCTYPE html>
<html lang="en"><head>
    <title>CONGX.DEV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://congx.dev//favicon.ico">
    <link rel="canonical" href="https://congx.dev/">
    
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.css">
    <link rel="stylesheet" href="/css/style.css">
    
</head><body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://congx.dev/">CONGX.DEV</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/readme">
                                    
                                    <span>README</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/posts/">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>Adding Talk to Ghost - Sat, Dec 22, 2018</h1>
    </div>
    <p class="lead"></p>
    

<p>Back when this blog still ran on Ghost, I added Mozilla Coral Project&rsquo;s Talk to Ghost, and&hellip;</p>

<p>Legit, adding <a href="https://coralproject.net/talk/">Talk</a> to Ghost is not as straightforward as the documentation. While the <a href="https://docs.coralproject.net/talk">Quick Start</a> is simple enough on running Talk on your own server, what they don&rsquo;t mention is the amount of overhead setup that comes with it. Being a noob to Ghost, NGINX and hosting a blog on my own server made the setup experience frustrating for me. But persistence prevailed, we now have comments!</p>

<blockquote>
<p>Talk is cool, I like Talk.</p>
</blockquote>

<p>So, how does this work?</p>

<p>For this, I am using Docker. It saves time from having to <a href="https://docs.coralproject.net/talk/planning-architecture/">compile code and dependencies</a>.</p>

<h1 id="setup-a-talk-subdomain-for-the-site">Setup a talk subdomain for the site</h1>

<p>Coral <a href="https://docs.coralproject.net/talk/configuration/">recommends</a> that we use something along the line of talk.domain.com. This configuration not only needs messing around with NGINX but also setting up a subdomain routing with your DNS server. Since I bought my domain from Namecheap, they&rsquo;ve got a guide on adding a subdomain.</p>

<p><img src="./talk-subdomain.png" alt="talk subdomain" /></p>

<p>Once that is configured, I added SSL and routing in my NGINX configurations. One point to note here is that to setup SSL successfully, I&rsquo;ve found that you have to wait for the DNS configuration to take effect. Namecheap says it could take anywhere up to 30 minutes for their system.</p>

<h1 id="create-a-folder-to-put-the-configuration-files">Create a folder to put the configuration files</h1>

<p>From this point onwards, I work out of a folder with path <code>/var/www/talk.lettus.xyz</code> owned by and editable by my non-root username. In this folder, I create a <code>.well_known</code> folder. I&rsquo;m not sure if the following step&rsquo;s script creates it for me, so I just make one anyway in case ghost-cli created it. It&rsquo;s used for manual verification that the DNS you&rsquo;re creating a SSL certificate for is indeed pointing to your server.</p>

<h1 id="add-ssl-to-the-new-subdomain">Add SSL to the new subdomain</h1>

<p>You can also use certbot for this step.</p>

<p>When setting up my blog, Ghost also setup SSL with LetsEncrypt. Behind the scenes, ghost-cli talks to the <a href="https://github.com/Neilpang/acme.sh">ACME client script</a>. You don&rsquo;t have to download/install the tool as Ghost already did this for you. The script at the time of this post (Dec 2018) sits in <code>/etc/letsencrypt</code> folder on your server.</p>

<p><img src="./lets-encrypt-acme.png" alt="Let's Encrypt Acme script" /></p>

<p>Working out of <code>/etc/letsencrypt</code>, you&rsquo;d follow the instructions on ACME&rsquo;s Git README from step 2 to 3. In step 3, paths to <code>key.pem</code> and <code>cert.pem</code> needs to be specified. Ghost uses <code>*.cer</code> and <code>*.key</code> for the <code>cert.pem</code> and <code>key.pem</code> files respectively as evident in their pre-configured SSL NGINX configuration file.</p>

<p><img src="./ssl-certificate-nginx.png" alt="SSL NGINX config" /></p>

<p>I then cloned Ghost&rsquo;s auto-generated NGINX configuration files into my <code>/var/www/talk.lettus.xyz</code> folder and modify them, editing the <code>server_name</code>, <code>root</code>, <code>ssl_cetificate</code>, <code>ssl_certificate_key</code> and proxy_pass parameters. The location for proxy_pass should point to your Talk&rsquo;s server location. For me, it is <a href="http://127.0.0.1:3000">http://127.0.0.1:3000</a>, which we can find out in the next step. At the end of this step, my SSL configuration file looks like the following block.</p>

<pre><code class="language-nginx">server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name talk.lettus.xyz;
    root /var/www/talk.lettus.xyz;

    ssl_certificate /var/www/talk.lettus.xyz/cert.pem;
    ssl_certificate_key /var/www/talk.lettus.xyz/key.pem;
    include /etc/nginx/snippets/ssl-params-no-frame.conf;

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:3000;
    }

    location ~ /.well-known {
        allow all;
    }


    client_max_body_size 50m;
}
</code></pre>

<p>A bit later on, you are going to configure Talk to allow its content to be displayed on your page. By default, NGINX&rsquo;s SSL configuration sets <code>X-Frame-Options to SAMEORIGIN</code>. While this is what you usually want, this setting won&rsquo;t allow Talk&rsquo;s comment HTML to be loaded at all. Talk server will check the sites for you anyway. So to fix this, you gotta edit 1 line in NGINX&rsquo;s <code>ssl-params.conf</code> file. To preserve default configurations for our blogs, I duplicated the <code>ssl-params.conf</code> and placed it in the same folder (<code>/etc/nginx/snippets/</code>) with a new name <code>ssl-params-no-frame.conf</code> and commented out add_header <code>X-Frame-Options SAMEORIGIN;</code>.</p>

<p>You can leave the <code>proxy_pass</code> address as your Ghost&rsquo;s blog to ensure navigating to <code>talk.your-domain.com</code> actually works.</p>

<h1 id="configure-and-start-talk">Configure and start Talk</h1>

<p>Finally we can start Talk&rsquo;s <a href="https://docs.coralproject.net/talk/">Quick Start guide</a> ðŸ˜Š. For Talk to work, you will need Redis and MongoDB. I created a free MongoDB database at mlab.com since I want the configuration and comments to probably persist when my VPS is upgraded or have health issues. Coral&rsquo;s already released v4.7 on their Docker Hub so I changed the version in the docker-compose file as well. There doesn&rsquo;t seem to be any breakage. Placing the final docker-compose.yml file into my Talk folder, it looks a bit like this:</p>

<pre><code class="language-yaml">version: '2'
services:
  talk:
    image: coralproject/talk:latest
    restart: always
    ports:
      - &quot;3000:3000&quot;
    depends_on:
      - redis
    environment:
      - TALK_MONGO_URL=mongodb://&lt;db-user&gt;:&lt;db-password&gt;@&lt;db-identifier&gt;.mlab.com:63989/&lt;database-name&gt;
      - TALK_REDIS_URL=redis://redis
      - TALK_ROOT_URL=https://talk.lettus.xyz
      - TALK_PORT=3000
      - TALK_JWT_SECRET=&lt;my-super-secret-password&gt;
  redis:
    image: redis:latest
    restart: always
    volumes:
      - redis:/data
volumes:
  redis:
    external: false
</code></pre>

<p>Port 3000 is published, which is what I used for <code>proxy_pass</code>. I created a free cluster with mlab so your <code>TALK_MONGO_URL</code> will look different. Lastly, replace <code>TALK_ROOT_URL</code> with your configured talk subdomain.</p>

<p>Then we just run <code>docker-compose up -d</code>.</p>

<h1 id="finalising-nginx-and-push-changes">Finalising NGINX and push changes</h1>

<p>Now that I had a Talk server running, <code>curl 127.0.0.1:3000</code> redirects me to some mysterious <code>/admin</code> page. Let&rsquo;s create a few symbolic links for our Talk NGINX configuration files and make sure NGINX is happy with our configurations.</p>

<p>Because I put all of my configuration files in <code>/var/www/talk.lettus.xyz</code>, I run the following two commands to create links to <code>/etc/nginx/sites-enabled</code>, similar to how ghost-cli does it.</p>

<pre><code>$ sudo ln -s /var/www/talk.lettus.xyz/talk.lettus.xyz.conf /etc/nginx/sites-enabled/
$ sudo ln -s /var/www/talk.lettus.xyz/talk.lettus.xyz-ssl.conf /etc/nginx/sites-enabled/
</code></pre>

<p>Then run <code>sudo nginx -t</code> to make sure NGINX is happy, and push the changes with <code>sudo nginx -s reload</code>.</p>

<h1 id="configuring-talk-s-admin-configurations">Configuring Talk&rsquo;s Admin Configurations</h1>

<p>Add a new admin, add in permitted domains, copy the Embed Comment Stream block of code in <code>Configure &gt; Tech Settings</code> and paste it into Ghost&rsquo;s footer block in our usual Ghost&rsquo;s code injector settings page.</p>

<h1 id="finishing-touches">Finishing touches</h1>

<p>Well, if you put the comments block into the footer, it&rsquo;s going to be below the footer, which isn&rsquo;t what you want. So you&rsquo;ve got to do a bit of scripting to insert the comments block just below your article like so:</p>

<pre><code class="language-html">&lt;script src=&quot;https://talk.lettus.xyz/static/embed.js&quot; async onload=&quot;
  var articles = document.querySelectorAll('.post-full.post');
  if (articles.length === 1) {
    var coral = document.createElement('div');
    coral.setAttribute('id', 'coral_talk_stream');
    articles[0].appendChild(coral);
    
    Coral.Talk.render(document.getElementById('coral_talk_stream'), {
      talk: 'https://talk.lettus.xyz/'
    });
  }
  
&quot;&gt;&lt;/script&gt;
</code></pre>

<p>Thanks to Snorre for his <a href="https://snorre.io/embedding-coral-talk-in-your-ghost-blog/">tip</a> on this but <code>getElementsByClassName</code> can&rsquo;t get 2 classes at a time mate. You gotta use <code>querySelectorAll</code>. Edit the code block with your own Talk&rsquo;s server details.</p>

<p>And that&rsquo;s it! Time to find out how to enable Google and Facebook commenting and all the plugins Talk have to offer.</p>

    <h4><a href="https://congx.dev/">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
        &copy; 
        <a href="congx.dev" target="_blank">
            Cong Nguyen
        </a>
        <span id="thisyear">2020</span>
        
             | Built on <a href="//gohugo.io" target="_blank">Hugo</a>
        
    </p>
    <p class="text-center">
        
        <a href="https://twitter.com/congxdev">Twitter</a> 
        <a href="https://linkedin.com/in/cong-ng">Linkedin</a> 
        <a href="https://github.com/rampadc">GitHub</a> 
        
    </p>
</footer>

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1.25 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></body>
</html>
